{% extends 'index.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin/trabajos_sin_asignar.css' %}">
{% endblock extra_css %}

{% block contenido %}
<div class="header">
    <a href="{% url 'ver_agenda' colaborador.id %}" id="btn-volver" class="btn btn-back">Volver</a>
    <h1>Trabajos sin asignar para {{ fecha }}</h1>
</div>
<div class="container">
    <div class="trabajos-list" id="trabajos-sin-asignar">
        <h2>Trabajos sin asignar</h2>
        <ul>
            {% for trabajo in trabajos_sin_asignar %}
            <li data-id="{{ trabajo.id }}">
                <p><strong>Nombre del Trabajo:</strong> {{ trabajo.nombre_trabajo }}</p>
                <p><strong>Telefono:</strong> {{ trabajo.telefono }}</p>
                <p><strong>Dirección:</strong> {{ trabajo.direccion }}</p>
                <p><strong>Hora Inicio:</strong> {{ trabajo.hora_inicio }}</p>
                <p><strong>Hora Termino:</strong> {{ trabajo.hora_termino }}</p>
                <p><strong>Estado:</strong> {{ trabajo.get_estado_display }}</p>
            </li>
            {% empty %}
            <li class="no-trabajos">No hay trabajos sin asignar para esta fecha.</li>
            {% endfor %}
        </ul>
    </div>

    <div class="buttons">
        <button id="btn-asignar">Asignar &gt;&gt;</button>
        <button id="btn-desasignar">&lt;&lt; Desasignar</button>
        <button id="btn-confirmar">Guardar</button>
    </div>

    <div class="trabajos-list" id="trabajos-asignados">
        <h2> Agenda de {{ colaborador.first_name }} {{ colaborador.last_name }}</h2>
        <ul>
            {% for trabajo in trabajos_asignados %}
            <li data-id="{{ trabajo.id }}" class="{{ trabajo.estado|lower }}">
                <p><strong>Nombre del Trabajo:</strong> {{ trabajo.nombre_trabajo }}</p>
                <p><strong>Telefono:</strong> {{ trabajo.telefono }}</p>
                <p><strong>Dirección:</strong> {{ trabajo.direccion }}</p>
                <p><strong>Hora Inicio:</strong> {{ trabajo.hora_inicio }}</p>
                <p><strong>Hora Termino:</strong> {{ trabajo.hora_termino }}</p>
                <p><strong>Estado:</strong> {{ trabajo.get_estado_display }}</p>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<form id="form-asignar" method="post" action="{% url 'asignar_trabajo' colaborador.id %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="trabajos" id="trabajos-input">
</form>

<div id="confirmation-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <p>¡Trabajos asignados con éxito!</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const btnAsignar = document.getElementById('btn-asignar');
    const btnDesasignar = document.getElementById('btn-desasignar');
    const btnConfirmar = document.getElementById('btn-confirmar');
    const trabajosSinAsignar = document.getElementById('trabajos-sin-asignar').querySelector('ul');
    const trabajosAsignados = document.getElementById('trabajos-asignados').querySelector('ul');
    const trabajosInput = document.getElementById('trabajos-input');
    const modal = document.getElementById('confirmation-modal');
    const closeModal = modal.querySelector('.close');

    function checkTrabajosAsignados() {
        if (trabajosAsignados.querySelectorAll('li').length > 0) {
            btnConfirmar.disabled = false;
        } else {
            btnConfirmar.disabled = true;
        }
    }

    btnConfirmar.disabled = true;

    btnAsignar.addEventListener('click', function () {
        const selectedItems = [...trabajosSinAsignar.querySelectorAll('li.selected')];
        selectedItems.forEach(item => {
            item.classList.remove('selected');
            trabajosAsignados.appendChild(item);
        });
        checkTrabajosAsignados();
    });

    btnDesasignar.addEventListener('click', function () {
        const selectedItems = [...trabajosAsignados.querySelectorAll('li.selected')];
        selectedItems.forEach(item => {
            item.classList.remove('selected');
            trabajosSinAsignar.appendChild(item);
        });
        checkTrabajosAsignados();
    });

    document.querySelectorAll('.trabajos-list ul').forEach(list => {
        list.addEventListener('click', function (e) {
            let target = e.target;
            while (target && target.tagName !== 'LI') {
                target = target.parentElement;
            }
            if (target && !target.classList.contains('no-trabajos') && !target.classList.contains('pendiente')) {
                target.classList.toggle('selected');
            }
        });
    });

    btnConfirmar.addEventListener('click', function (e) {
        e.preventDefault();
        const trabajosAsignadosIds = [...trabajosAsignados.querySelectorAll('li')].map(item => item.dataset.id);
        trabajosInput.value = trabajosAsignadosIds.join(',');
        modal.style.display = 'block';
    });

    closeModal.addEventListener('click', function () {
        modal.style.display = 'none';
        document.getElementById('form-asignar').submit();
    });

    window.addEventListener('click', function (event) {
        if (event.target == modal) {
            modal.style.display = 'none';
            document.getElementById('form-asignar').submit();
        }
    });

    checkTrabajosAsignados();
});
</script>
{% endblock %}
