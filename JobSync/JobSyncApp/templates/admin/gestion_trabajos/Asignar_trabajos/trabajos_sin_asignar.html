{% extends 'index.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin/trabajos_sin_asignar.css' %}">
{% endblock extra_css %}

{% block contenido %}
<div class="header">
    <a href="{% url 'ver_agenda' colaborador.id %}" id="btn-volver" class="btn btn-back">Volver</a>
    <h1>Trabajos sin asignar para {{ fecha }}</h1>
</div>

<div class="container">
    <div class="trabajos-list" id="trabajos-sin-asignar">
        <h2>Trabajos sin asignar</h2>
        <ul>
            {% for trabajo in trabajos_sin_asignar %}
            <li data-id="{{ trabajo.id }}" data-estado="{{ trabajo.estado }}" data-reagendado-contador="{{ trabajo.reagendado_contador }}" {% if trabajo.error %}class="error"{% endif %}>
                <p><strong>Nombre del Trabajo:</strong> {{ trabajo.nombre_trabajo }}</p>
                <p><strong>Telefono:</strong> {{ trabajo.telefono }}</p>
                <p><strong>Dirección:</strong> {{ trabajo.direccion }}</p>
                <p><strong>Hora Inicio:</strong> {{ trabajo.hora_inicio }}</p>
                <p><strong>Hora Termino:</strong> {{ trabajo.hora_termino }}</p>
                <p><strong>Estado:</strong> {{ trabajo.get_estado_display }}</p>
            </li>
            {% empty %}
            <li class="no-trabajos">No hay trabajos sin asignar para esta fecha.</li>
            {% endfor %}
        </ul>
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div class="buttons">
        <button id="btn-asignar">Asignar &gt;&gt;</button>
        <button id="btn-desasignar">&lt;&lt; Desasignar</button>
        <button id="btn-confirmar">Guardar</button>
    </div>

    <div class="trabajos-list" id="trabajos-asignados">
        <h2> Agenda</h2>
        <ul>
            {% for trabajo in trabajos_asignados %}
            <li data-id="{{ trabajo.id }}" class="{{ trabajo.estado|lower }}" data-estado="{{ trabajo.estado }}" data-reagendado-contador="{{ trabajo.reagendado_contador }}">
                <p><strong>Nombre del Trabajo:</strong> {{ trabajo.nombre_trabajo }}</p>
                <p><strong>Telefono:</strong> {{ trabajo.telefono }}</p>
                <p><strong>Dirección:</strong> {{ trabajo.direccion }}</p>
                <p><strong>Hora Inicio:</strong> {{ trabajo.hora_inicio }}</p>
                <p><strong>Hora Termino:</strong> {{ trabajo.hora_termino }}</p>
                <p><strong>Estado:</strong> {{ trabajo.get_estado_display }}</p>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<form id="form-asignar" method="post" action="{% url 'asignar_trabajo' colaborador.id %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="trabajos" id="trabajos-input">
</form>
{% endblock %}

{% block extra_js %}
<script>
 document.addEventListener('DOMContentLoaded', function () {
    const btnAsignar = document.getElementById('btn-asignar');
    const btnDesasignar = document.getElementById('btn-desasignar');
    const btnConfirmar = document.getElementById('btn-confirmar');
    const trabajosSinAsignar = document.getElementById('trabajos-sin-asignar').querySelector('ul');
    const trabajosAsignados = document.getElementById('trabajos-asignados').querySelector('ul');
    const trabajosInput = document.getElementById('trabajos-input');

    function checkTrabajosAsignados() {
        if (trabajosAsignados.querySelectorAll('li').length > 0) {
            btnConfirmar.disabled = false;
        } else {
            btnConfirmar.disabled = true;
        }
    }

    btnConfirmar.disabled = true;

    btnAsignar.addEventListener('click', function () {
        const selectedItems = [...trabajosSinAsignar.querySelectorAll('li.selected')];
        selectedItems.forEach(item => {
            item.classList.remove('selected');
            trabajosAsignados.appendChild(item);
        });
        checkTrabajosAsignados();
    });

    btnDesasignar.addEventListener('click', function () {
        const selectedItems = [...trabajosAsignados.querySelectorAll('li.selected')];
        selectedItems.forEach(item => {
            item.classList.remove('selected');
            trabajosSinAsignar.appendChild(item);
        });
        checkTrabajosAsignados();
    });

    document.querySelectorAll('.trabajos-list ul').forEach(list => {
        list.addEventListener('click', function (e) {
            const li = e.target.closest('li');
            if (li && !li.classList.contains('no-trabajos') && !li.classList.contains('pendiente') && !li.classList.contains('reagendado') && !li.classList.contains('completado') && !li.classList.contains('cancelado')) {
                li.classList.toggle('selected');
            }
        });
    });

    btnConfirmar.addEventListener('click', function (e) {
        e.preventDefault();
        const trabajosAsignadosIds = [...trabajosAsignados.querySelectorAll('li:not([data-id^="existing"])')].map(item => item.dataset.id);
        trabajosInput.value = trabajosAsignadosIds.join(',');
        document.getElementById('form-asignar').submit();
    });

    checkTrabajosAsignados();
});


</script>
{% endblock %}
